-- Load WindUI (Advanced Version) - improved with search + FPS/Ping + Keybind
local WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()

-- ---------- Utility: gradient ----------
local function gradient(text, startColor, endColor)
    local len = #text
    if len == 0 then return text end
    local r1,g1,b1 = startColor.R * 255, startColor.G * 255, startColor.B * 255
    local r2,g2,b2 = endColor.R * 255, endColor.G * 255, endColor.B * 255
    local tparts = table.create(len)
    for i = 1, len do
        local t = (i - 1) / math.max(len - 1, 1)
        local r = math.floor(r1 + (r2 - r1) * t)
        local g = math.floor(g1 + (g2 - g1) * t)
        local b = math.floor(b1 + (b2 - b1) * t)
        tparts[i] = string.format('<font color="rgb(%d,%d,%d)">%s</font>', r, g, b, text:sub(i,i))
    end
    return table.concat(tparts)
end

-- ---------- Popup Welcome ----------
local Confirmed = false
WindUI:Popup({
    Title = "Welcome to ro-archive!",
    Icon = "rbxassetid://129260712070622",
    IconThemed = true,
    Content = "Welcome to the " .. gradient("ro-archive", Color3.fromRGB(0,255,135), Color3.fromRGB(96,239,255)) .. ".\nScripts may auto-close the UI!",
    Buttons = {
        { Title = "Close", Variant = "Secondary", Callback = function() end },
        { Title = "Continue", Icon = "arrow-right", Variant = "Primary", Callback = function() Confirmed = true end }
    }
})
repeat task.wait() until Confirmed

-- ---------- Create Main Window ----------
local Window = WindUI:CreateWindow({
    Title = "ro-archive",
    Icon = "archive",
    Author = "sdwird",
    Folder = "CloudHub",
    Size = UDim2.fromOffset(580, 460),
    Transparent = true,
    Theme = "Dark",
    SideBarWidth = 200,
    ScrollBarEnabled = true,
    KeySystem = {
        Key = { "1234" },
        Note = "The key is 1234",
        SaveKey = false,
    },
    User = { Enabled = true, Anonymous = true }
})

-- default toggle key (can be changed via settings keybind)
local defaultToggleKey = Enum.KeyCode.H
Window:SetToggleKey(defaultToggleKey)

Window:CreateTopbarButton("Info", "info", function()
    WindUI:Notify({ Title = "ro-archive", Content = "Made by sdwird", Duration = 5 })
end, 998)

-- ---------- Homepage ----------
local HomeTab = Window:Tab({ Title = "Homepage", Icon = "house" })
HomeTab:Paragraph({
    Title = "enjoy being a dickhead",
    Desc = "wassup exploiter"
})
HomeTab:Button({
    Title = "Close ui",
    Icon = "eye-off",
    Callback = function() Window:Toggle() end
})

-- ---------- Scripts data (single source of truth) ----------
-- Keep script entries in a table so search can use them (doesn't remove existing Buttons)
local scriptsList = {
    {
        Title = "Zenware Crim Aimlock",
        Desc = "Key: NewSigmaSigmaBoy",
        Icon = "target",
        Url = "https://raw.githubusercontent.com/sdwird/ro-archive/refs/heads/main/zenware-criminality.lua",
        After = function() setclipboard("NewSigmaSigmaBoy") end
    },
    {
        Title = "Demonology ESP",
        Icon = "eye",
        Url = "https://raw.githubusercontent.com/sdwird/ro-archive/refs/heads/main/demonology-esp.lua"
    },
    {
        Title = "Build A Boat Script",
        Icon = "anchor",
        Url = "https://raw.githubusercontent.com/sdwird/ro-archive/refs/heads/main/babft-asu.lua"
    },
    -- you can append more entries here easily
}

local function safeLoad(url)
    local ok, res = pcall(function() return game:HttpGet(url, true) end)
    if ok and res and #res > 0 then
        local ok2, err = pcall(loadstring(res))
        if not ok2 then
            warn("Failed executing script from URL:", url, err)
        end
    else
        warn("Failed fetching URL:", url)
    end
end

-- ---------- Scripts Tab (with Search Input) ----------
local ScriptsTab = Window:Tab({ Title = "Scripts", Icon = "book-text" })

-- Search input â€” uses WindUI Input; when the user types and presses Enter, show popup with matches
ScriptsTab:Input({
    Title = "Search scripts",
    Placeholder = "Type script name and press Enter...",
    Callback = function(value)
        if not value or value == "" then
            WindUI:Notify({ Title = "Search", Content = "Type something to search.", Duration = 3 })
            return
        end

        local q = value:lower()
        local matches = {}
        for _, s in ipairs(scriptsList) do
            if s.Title:lower():find(q) or (s.Desc and s.Desc:lower():find(q)) then
                table.insert(matches, s)
            end
        end

        if #matches == 0 then
            WindUI:Notify({ Title = "Search", Content = "No scripts found for: " .. value, Duration = 4 })
            return
        end

        -- Build popup buttons from matches (max 6 to avoid huge popups)
        local buttons = {}
        for i = 1, math.min(6, #matches) do
            local s = matches[i]
            table.insert(buttons, {
                Title = s.Title,
                Desc = s.Desc or "",
                Icon = s.Icon or "",
                Callback = function()
                    if s.After then
                        pcall(s.After)
                    end
                    safeLoad(s.Url)
                end
            })
        end

        WindUI:Popup({
            Title = "Search results (" .. tostring(#matches) .. ")",
            Content = "Click a result to execute it.",
            Buttons = buttons
        })
    end
})

-- Also create default quick access Buttons (keeps original UX)
for _, s in ipairs(scriptsList) do
    ScriptsTab:Button({
        Title = s.Title,
        Desc = s.Desc,
        Icon = s.Icon,
        Callback = function()
            if s.After then pcall(s.After) end
            safeLoad(s.Url)
        end
    })
end

-- ---------- Universal Tab ----------
local UniversalTab = Window:Tab({ Title = "Universal", Icon = "globe" })
UniversalTab:Button({
    Title = "Infinite Yield",
    Icon = "terminal",
    Callback = function()
        safeLoad("https://raw.githubusercontent.com/EdgeIY/infiniteyield/master/source")
    end
})

-- ---------- Hubs Tab ----------
local HubsTab = Window:Tab({ Title = "Hubs", Icon = "grid" })
HubsTab:Button({ Title = "Skibidi Solara Hub (Orion)", Icon = "zap", Callback = function()
    safeLoad("https://raw.githubusercontent.com/sdwird/ro-archive/refs/heads/main/skibidi-solara-hub.lua")
end })
HubsTab:Button({ Title = "Skibidi Solara Hub (Auto Detect)", Icon = "radar", Callback = function()
    safeLoad("https://raw.githubusercontent.com/sdwird/ro-archive/refs/heads/main/skibidihub-rayfield")
end })
HubsTab:Button({ Title = "Solara hub", Icon = "folder-open", Callback = function()
    safeLoad("https://raw.githubusercontent.com/sdwird/ro-archive/refs/heads/main/solara-hub.lua")
end })

-- ---------- Settings Tab (renamed to "UI" as you requested) ----------
local SettingsTab = Window:Tab({ Title = "UI", Icon = "settings" })
local HttpService = game:GetService("HttpService")
local folderPath = "WindUI"
pcall(function() makefolder(folderPath) end)

local cfgFile = "archive_config"

local function SaveFile(name, data)
    local ok, err = pcall(function()
        writefile(folderPath .. "/" .. name .. ".json", HttpService:JSONEncode(data))
    end)
    if not ok then warn("Failed saving config:", err) end
end
local function LoadFile(name)
    local path = folderPath .. "/" .. name .. ".json"
    if isfile(path) then
        local ok, data = pcall(function() return HttpService:JSONDecode(readfile(path)) end)
        if ok then return data end
    end
    return nil
end

-- Theme selector
local themeNames = {}
for name in pairs(WindUI:GetThemes()) do table.insert(themeNames, name) end
SettingsTab:Dropdown({
    Title = "Select Theme",
    Values = themeNames,
    Value = WindUI:GetCurrentTheme(),
    Callback = function(theme) WindUI:SetTheme(theme) end
})

-- Window Transparency toggle
SettingsTab:Toggle({
    Title = "Window Transparency",
    Value = WindUI:GetTransparency(),
    Callback = function(state) Window:ToggleTransparency(state) end
})

-- Keybind to change UI toggle key (uses WindUI Keybind example)
local currentKey = "H"
SettingsTab:Keybind({
    Flag = "UIToggleKeybind",
    Title = "Toggle UI Key",
    Desc = "Set a key to open/close UI (default H)",
    Value = currentKey,
    Callback = function(v)
        -- v is expected as string of key name, e.g. "H"
        currentKey = v
        local ok, enum = pcall(function() return Enum.KeyCode[v] end)
        if ok and enum then
            Window:SetToggleKey(enum)
            WindUI:Notify({ Title = "Keybind", Content = "Toggle key set to: " .. tostring(v), Duration = 3 })
        else
            warn("Invalid Key:", v)
        end
    end
})

-- ---------- FPS & Ping HUD (toggleable, stylish) ----------
-- We'll create a small ScreenGui with a styled label; toggles in Settings control visibility.
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- create HUD once (but don't parent yet)
local function createHudGui()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "roArchiveStatsHud"
    screenGui.ResetOnSpawn = false

    local frame = Instance.new("Frame")
    frame.Name = "StatsFrame"
    frame.Size = UDim2.fromOffset(180, 36)
    frame.Position = UDim2.new(0.02, 0, 0.02, 0)
    frame.AnchorPoint = Vector2.new(0,0)
    frame.BackgroundTransparency = 0.99
    frame.BackgroundColor3 = Color3.fromRGB(255,255,255)
    frame.BorderSizePixel = 0
    frame.ZIndex = 9999
    frame.Parent = screenGui

    -- rounded corner
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = frame

    -- label
    local label = Instance.new("TextLabel")
    label.Name = "StatsLabel"
    label.Size = UDim2.fromScale(1,1)
    label.Position = UDim2.fromOffset(0,0)
    label.BackgroundTransparency = 1
    label.TextScaled = false
    label.Font = Enum.Font.GothamSemibold
    label.TextSize = 14
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.TextYAlignment = Enum.TextYAlignment.Center
    label.TextColor3 = Color3.fromRGB(255,255,255)
    label.RichText = false
    label.Text = "FPS: -- | Ping: -- ms"
    label.Parent = frame

    -- drag functionality (simple)
    local dragging = true
    local dragInput, dragStart, startPos
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    frame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    RunService.Heartbeat:Connect(function()
        if dragging and dragInput then
            local delta = UserInputService:GetMouseLocation() - dragStart
            local screenW, screenH = workspace.CurrentCamera.ViewportSize.X, workspace.CurrentCamera.ViewportSize.Y
            local newX = startPos.X.Scale + (delta.X / screenW)
            local newY = startPos.Y.Scale + (delta.Y / screenH)
            frame.Position = UDim2.new(math.clamp(newX, 0, 1), 0, math.clamp(newY, 0, 1), 0)
        end
    end)

    return screenGui, label
end

-- Note: get Data Ping parsing function (community-used)
local function getPingMs()
    local ok, stats = pcall(function() return game:GetService("Stats").Network.ServerStatsItem["Data Ping"]:GetValueString() end)
    if ok and stats then
        local n = tonumber(string.match(stats, "%d+")) or nil
        if n then return n end
    end
    -- fallback: try LocalPlayer:GetNetworkPing() (returns seconds)
    local ok2, ping = pcall(function() return LocalPlayer:GetNetworkPing() end)
    if ok2 and ping then
        return math.floor(ping * 1000)
    end
    return 0
end

-- create HUD (but parent later)
local UserInputService = game:GetService("UserInputService")
local hudGui, statsLabel = createHudGui()
local hudParented = false
local hudRunning = false
local lastRenderTick = tick()
local avgDt = 0

local hudUpdateConn
local function startHud()
    if hudParented then return end
    hudGui.Parent = game:GetService("CoreGui") or game:GetService("Players").LocalPlayer:WaitForChild("PlayerGui")
    hudParented = true
    hudRunning = true
    -- update loop
    hudUpdateConn = RunService.RenderStepped:Connect(function(dt)
        -- FPS: simple low-pass of dt to stabilize
        avgDt = (avgDt * 0.85) + (dt * 0.15)
        local fps = math.floor(1 / math.max(0.0001, avgDt))
        local ping = getPingMs()
        statsLabel.Text = ("FPS: %d | Ping: %d ms"):format(fps, ping)
    end)
end

local function stopHud()
    if hudUpdateConn then
        hudUpdateConn:Disconnect()
        hudUpdateConn = nil
    end
    if hudGui and hudGui.Parent then
        hudGui.Parent = nil
    end
    hudParented = false
    hudRunning = false
end

-- Settings toggles to control HUD
SettingsTab:Toggle({
    Title = "Show FPS & Ping HUD",
    Value = false,
    Callback = function(state)
        if state then startHud() else stopHud() end
    end
})

-- ---------- Save / Load Buttons (keep functionality, but include new fields) ----------
SettingsTab:Button({
    Title = "Save Settings",
    Callback = function()
        SaveFile(cfgFile, {
            Theme = WindUI:GetCurrentTheme(),
            Transparent = WindUI:GetTransparency(),
            UIToggleKey = tostring(currentKey),
            HUDEnabled = hudRunning
        })
        WindUI:Notify({ Title = "Saved", Content = "Settings saved", Duration = 3 })
    end
})

SettingsTab:Button({
    Title = "Load Settings",
    Callback = function()
        local data = LoadFile(cfgFile)
        if data then
            if data.Theme then WindUI:SetTheme(data.Theme) end
            if data.Transparent ~= nil then Window:ToggleTransparency(data.Transparent) end
            if data.UIToggleKey then
                local keyname = tostring(data.UIToggleKey)
                pcall(function()
                    Window:SetToggleKey(Enum.KeyCode[keyname])
                end)
            end
            if data.HUDEnabled then startHud() else stopHud() end
            WindUI:Notify({ Title = "Loaded", Content = "Settings loaded", Duration = 3 })
        else
            WindUI:Notify({ Title = "Load", Content = "No saved config found.", Duration = 3 })
        end
    end
})

-- ---------- Close Event ----------
Window:OnClose(function()
    -- cleanup HUD if open
    pcall(stopHud)
    print("ro-archive closed.")
end)
